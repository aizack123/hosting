
<!DOCTYPE html>
<html>
<head>
    <title>Mapa de Localizaciones - Bolivia</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Leaflet CSS (CDN con respaldo local) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin="anonymous">
    <script>
    // Función para cargar recursos con respaldo
    function loadResource(url, integrity, callback) {
        var script = document.createElement('script');
        script.src = url;
        if(integrity) script.integrity = integrity;
        script.crossOrigin = 'anonymous';
        script.onerror = function() {
            console.error('Error cargando: ' + url);
            // Implementar respaldo aquí si es necesario
        };
        script.onload = callback;
        document.head.appendChild(script);
    }
    
    // Versión local simplificada de toGeoJSON
    function setupKMLParser() {
        window.toGeoJSON = {
            kml: function(kmlDoc) {
                try {
                    var placemarks = kmlDoc.getElementsByTagName('Placemark');
                    var features = [];
                    
                    for (var i = 0; i < placemarks.length; i++) {
                        var placemark = placemarks[i];
                        var name = getChildValue(placemark, 'name') || 'Punto ' + (i+1);
                        var coords = getCoordinates(placemark);
                        
                        if (coords && coords.length > 0) {
                            features.push({
                                type: 'Feature',
                                properties: { name: name },
                                geometry: {
                                    type: 'Point',
                                    coordinates: [coords[0][0], coords[0][1]]
                                }
                            });
                        }
                    }
                    
                    return {
                        type: 'FeatureCollection',
                        features: features
                    };
                } catch(e) {
                    console.error('Error parsing KML:', e);
                    return { type: 'FeatureCollection', features: [] };
                }
            }
        };
        
        function getChildValue(node, tagName) {
            var children = node.getElementsByTagName(tagName);
            return children.length > 0 ? children[0].textContent : null;
        }
        
        function getCoordinates(placemark) {
            var points = placemark.getElementsByTagName('Point');
            if (points.length === 0) return null;
            
            var coordStr = getChildValue(points[0], 'coordinates');
            if (!coordStr) return null;
            
            var parts = coordStr.trim().split(/\s*,\s*/);
            if (parts.length < 2) return null;
            
            return [[parseFloat(parts[0]), parseFloat(parts[1])]];
        }
    }
    </script>
</head>
<body>
    <div id="map"></div>
    <div class="info">
        <h3>Mapa de Localizaciones</h3>
        <p>Actualizado: 2025-07-23 02:06</p>
    </div>
    
    <!-- Cargar Leaflet desde CDN con respaldo local -->
    <script>
    // Primero configuramos el parser KML local
    setupKMLParser();
    
    // Luego cargamos Leaflet
    loadResource('https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js', 
                'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=',
                function() {
                    // Una vez cargado Leaflet, iniciamos el mapa
                    initMap();
                });
    
    function initMap() {
        // Mapa centrado en Bolivia
        var map = L.map('map').setView([-16.2902, -63.5887], 6);
        
        // Capa base
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            maxZoom: 18
        }).addTo(map);
        
        // Cargar KML
        fetch('https://raw.githubusercontent.com/aizack123/mapas/main/geo.kml')
            .then(function(response) {
                if (!response.ok) throw new Error('HTTP ' + response.status);
                return response.text();
            })
            .then(function(kmlText) {
                try {
                    var parser = new DOMParser();
                    var kmlDoc = parser.parseFromString(kmlText, 'text/xml');
                    
                    // Convertir KML a GeoJSON usando nuestra implementación
                    var geoJson = toGeoJSON.kml(kmlDoc);
                    
                    // Mostrar en el mapa
                    var features = L.geoJSON(geoJson, {
                        pointToLayer: function(feature, latlng) {
                            return L.marker(latlng, {
                                title: feature.properties.name || 'Punto'
                            });
                        },
                        onEachFeature: function(feature, layer) {
                            if (feature.properties && feature.properties.name) {
                                layer.bindPopup(feature.properties.name);
                            }
                        }
                    }).addTo(map);
                    
                    // Ajustar vista si hay features
                    if (features.getLayers().length > 0) {
                        map.fitBounds(features.getBounds());
                    } else {
                        console.warn('El KML no contiene puntos válidos');
                    }
                } catch(e) {
                    console.error('Error procesando KML:', e);
                    alert('Error al procesar los datos del mapa.');
                }
            })
            .catch(function(err) {
                console.error('Error cargando KML:', err);
                alert('No se pudieron cargar los datos del mapa.');
            });
    }
    </script>
    
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        .info {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-family: Arial, sans-serif;
            max-width: 300px;
        }
    </style>
</body>
</html>
    